<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Vacation Calendar</title>
  <meta name="description" content="HTML/JS vacation calendar that reads Google Sheets and shows requests in a traditional month grid." />
  <style>
    :root{
      --bg:#0f1220; --panel:#151a2b; --ink:#eaf0ff; --muted:#9aa5c1; --line:#28314d;
      --accent:#6ea8ff; --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    .app{max-width:1200px;margin:0 auto;padding:18px}
  
    /* Header: title left, controls right, nav centered */
    header{
      position:relative;                 /* anchor for the centered nav */
      display:flex;
      align-items:center;
      justify-content:space-between;     /* title left, controls right */
      margin-bottom:14px;
      gap:12px;
    }
    .title{display:flex;align-items:center;gap:10px}
    .title h1{font-size:18px;margin:0}
  
    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;          /* keep Refresh on the right */
    }
    .btn{background:var(--panel);border:1px solid var(--line);padding:6px 10px;border-radius:10px;color:var(--ink);cursor:pointer}
    .btn:hover{border-color:#3a4671}
  
    /* Center the (◀ Month ▶) nav over the header */
    .nav{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      display:flex; align-items:center; gap:6px;
      background:var(--panel);
      border:1px solid var(--line);
      padding:6px 8px;
      border-radius:12px;
      width:240px;                       /* fixed width box */
      justify-content:space-between;     /* space buttons + label */
    }
    .nav button{all:unset;cursor:pointer;padding:4px 8px;border-radius:8px}
    .nav button:hover{background:#1d2745}
    .month-label{flex:1;text-align:center;font-weight:600}
  
    /* Legend */
    .legend{display:flex;gap:14px;align-items:center;color:var(--muted);margin:8px 0 16px}
    .chip{display:inline-flex;align-items:center;gap:8px}
    .chip .swatch{width:18px;height:12px;border-radius:3px;border:1px solid #0004;box-shadow:inset 0 0 0 1px #fff2}
    /* Pending swatch with diagonal stripes overlay */
    .chip .pending{background:#6ea8ff;position:relative;overflow:hidden}
    .chip .pending::after{
      content:"";position:absolute;inset:0;
      background-image:repeating-linear-gradient(135deg, rgba(255,255,255,.65) 0 6px, rgba(255,255,255,0) 6px 12px);
    }
  
    /* Month grid */
    .calendar{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .dow-row{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line)}
    .dow-row div{
      padding:8px 10px;
      color:var(--muted);
      font-weight:600;
      text-transform:uppercase;
      font-size:11px;
      text-align:center;               /* center weekday labels */
    }
  
    .monthgrid{display:grid;grid-template-columns:repeat(7,1fr)}
    .daycell{
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:6px;
      position:relative;
      height:130px;                    /* adjust to change tile height */
      background:#121735;
    }
    .daycell:nth-child(7n){border-right:none}
    .daynum{position:absolute;top:6px;right:8px;font-weight:700;color:var(--muted)}
    .outside{background:#0f132b}
  
    .stack{display:flex;flex-direction:column;gap:4px;margin-top:18px;max-height:calc(100% - 22px);overflow:auto;padding-right:2px}
  
    .bar{
      height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;
      padding:0 6px;color:#0b1022;font-weight:700;overflow:hidden;cursor:default;
      white-space:nowrap;text-overflow:ellipsis;position:relative;
    }
    /* transparent diagonal stripes for Pending bars */
    .bar.pending::after{
      content:"";position:absolute;inset:0;z-index:1;
      background-image:repeating-linear-gradient(135deg, rgba(255,255,255,.65) 0 8px, rgba(255,255,255,0) 8px 16px);
      pointer-events:none;
    }
    /* put the label above the stripes */
    .bar .label{position:relative;z-index:2;}
  
    @media (max-width:900px){
      .app{padding:12px}
      .month-label{min-width:140px}
      .daycell{height:70px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 2v3M17 2v3M3.5 9h17M4 7c0-1.657 1.343-3 3-3h10c1.657 0 3 1.343 3 3v12c0 1.657-1.343 3-3 3H7c-1.657 0-3-1.343-3-3V7Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <h1>Team Vacation Calendar</h1>
      </div>

      <div class="controls">
        <div class="nav">
          <button id="prevBtn" title="Previous month">⟨</button>
          <button id="centerBtn" title="Current month"></button>
          <button id="nextBtn" title="Next month">⟩</button>
        </div>
        <button class="btn" id="refreshBtn" title="Reload data">↻ Refresh</button>
      </div>
    </header>

    <div class="legend">
      <div class="chip"><span class="swatch" style="background:#6ea8ff"></span> Approved</div>
      <div class="chip"><span class="swatch pending" style="background:#6ea8ff"></span> Pending</div>
    </div>

    <div id="calendar" class="calendar">
      <div class="dow-row">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div id="monthgrid" class="monthgrid"></div>
    </div>
  </div>

  <script>
  /* 1) EDIT THIS: link to your published-to-web CSV of the responses tab */
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1y2d5xHbDbg-iy8m6XJIqkRdUEr2gYLEDQdA6lMDX4mg/export?format=csv&gid=1860620676";

  /* UTILITIES */
  function fmtMonth(date){ return date.toLocaleString(undefined,{month:'long',year:'numeric'}); }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
  function clampDate(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function parseDateLoose(s){
    const iso = /^\d{4}-\d{2}-\d{2}$/; if(iso.test(s)) return new Date(s+"T00:00:00");
    const t = Date.parse(s); return isNaN(t) ? null : new Date(t);
  }
  function nameToColor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360; return `hsl(${hue} 70% 65%)`; }

  /* CSV FETCH/PARSE */
  async function fetchCSV(url){ const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error(`Failed to load sheet: ${res.status}`); return res.text(); }
  function parseCSV(text){
    function csvToRows(t){ const rows=[]; let row=[],cur='',q=false;
      for(let i=0;i<t.length;i++){ const c=t[i], n=t[i+1];
        if(c=='"'){ if(q && n=='"'){ cur+='"'; i++; } else q=!q; }
        else if(c==',' && !q){ row.push(cur); cur=''; }
        else if((c=='\n'||c=='\r') && !q){ if(c=='\r'&&n=='\n') i++; row.push(cur); rows.push(row); row=[]; cur=''; }
        else cur+=c;
      }
      if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
      return rows.filter(r=>r.length && r.some(x=>String(x).trim()!==''));
    }
    const rows = csvToRows(text);
    const header = rows.shift().map(s=>String(s).trim());
    const find = (re)=> header.findIndex(h=>re.test(h));
    const idx = {
      name:  find(/^employee\s*name$/i),
      start: find(/^start\s*date$/i),
      end:   find(/^end\s*date$/i),
      ret:   find(/^return\s*date$/i),
      status:find(/^(overall\s*status|status)$/i),
      req:   find(/^request\s*#$/i)
    };
    const out=[];
    for(const r of rows){
      const nm=(r[idx.name]||'').trim();
      const sd=parseDateLoose((r[idx.start]||'').trim());
      let ed=null;
      if(idx.end!==-1){ ed=parseDateLoose((r[idx.end]||'').trim()); }
      else if(idx.ret!==-1){
        const ret=parseDateLoose((r[idx.ret]||'').trim());
        if(ret) ed=new Date(ret.getFullYear(),ret.getMonth(),ret.getDate()-1); // Return = first day back
      }
      const raw=(r[idx.status]||'').trim();
      const st=/approved|complete/i.test(raw)?'Approved':'Pending';
      if(!nm||!sd||!ed) continue;

      const reqNumRaw = idx.req !== -1 ? (r[idx.req] || '').trim() : '';
      const reqNum = reqNumRaw === '' ? null : Number(reqNumRaw);

      out.push({ name:nm, start:clampDate(sd), end:clampDate(ed), status:st, requestNum:reqNum });
    }
    return out;
  }

  /* MONTH GRID */
  const monthgrid=document.getElementById('monthgrid');
  const centerBtn = document.getElementById('centerBtn');
  let currentMonth = startOfMonth(new Date());

  document.getElementById('prevBtn').onclick=()=>{ currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()-1,1); render(); };
  document.getElementById('nextBtn').onclick=()=>{ currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()+1,1); render(); };
  document.getElementById('refreshBtn').onclick=()=>render();

  function updateMonthLabel(){
    const label = fmtMonth(currentMonth);
    centerBtn.textContent = label;  // show month/year in the nav box center
  }

  function daysMatrix(monthStart){
    // Build a 6x7 grid starting on Sunday
    const firstDow = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1).getDay(); // 0 Sun .. 6 Sat
    const daysInThis = endOfMonth(monthStart).getDate();
    const cells = [];
    for(let i=0;i<firstDow;i++) cells.push({date:null, outside:true}); // leading blanks
    for(let d=1; d<=daysInThis; d++) cells.push({date:new Date(monthStart.getFullYear(), monthStart.getMonth(), d), outside:false});
    while(cells.length<42) cells.push({date:null, outside:true});      // trailing blanks to 6 rows
    return cells;
  }

  function expandVacationsIntoDays(vacs){
    const map = new Map(); // key: yyyy-mm-dd
    const key = d => d.toISOString().slice(0,10);
    for(const v of vacs){
      for(let t=new Date(v.start); t<=v.end; t=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1)){
        const k=key(t); if(!map.has(k)) map.set(k,[]); map.get(k).push(v);
      }
    }
    return map;
  }

  async function render(){
    updateMonthLabel();

    let vacs=[];
    try{ const csv=await fetchCSV(SHEET_CSV_URL); vacs=parseCSV(csv); }
    catch(err){ monthgrid.innerHTML = `<div style="padding:16px">⚠️ ${err.message}</div>`; return; }

    const dayMap = expandVacationsIntoDays(vacs);
    const cells = daysMatrix(currentMonth);

    monthgrid.innerHTML = '';
    for(const cell of cells){
      const el = document.createElement('div');
      el.className = 'daycell' + (cell.outside ? ' outside' : '');
      const num = document.createElement('div'); num.className='daynum'; num.textContent = cell.date ? cell.date.getDate() : '';
      el.appendChild(num);
      const stack = document.createElement('div'); stack.className='stack'; el.appendChild(stack);

      if(cell.date){
        const k = cell.date.toISOString().slice(0,10);
        // Sort by Request # (lowest first), then name
        const items = (dayMap.get(k)||[]).slice().sort((a,b)=>{
          const ar = (a.requestNum==null ? Number.POSITIVE_INFINITY : a.requestNum);
          const br = (b.requestNum==null ? Number.POSITIVE_INFINITY : b.requestNum);
          if (ar !== br) return ar - br;
          return a.name.localeCompare(b.name);
        });
        for(const v of items){
          const bar = document.createElement('div');
		  bar.className = 'bar' + (v.status==='Pending' ? ' pending' : '');
		  bar.style.background = nameToColor(v.name);

		  const label = document.createElement('span');
		  label.className = 'label';
		  label.textContent = v.name;
		  bar.appendChild(label);

		  // no tooltip on bars
		  bar.removeAttribute('title');

		  stack.appendChild(bar);
        }
      }
      monthgrid.appendChild(el);
    }
  }

  render();
  </script>
</body>
</html>
